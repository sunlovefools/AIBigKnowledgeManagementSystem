from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
import aiohttp
from typing import List, Dict, Any

from app.service.query_refiner import refine_query
from app.service.embedder import embed_text
from app.service.vector_store import search_similar_chunks
from app.service.answer_generator import generate_answer

# Setup the API router
router = APIRouter()


# --- Request/Response Models ---
class QueryRequest(BaseModel):
    query: str
    top_k: int = 5  # Number of similar documents to retrieve


class RetrievedChunk(BaseModel):
    content: str
    document_name: str
    page_number: int
    chunk_number: int
    similarity_score: float
    uploaded_by: str
    timestamp: str


class QueryResponse(BaseModel):
    # original_query: str
    # refined_query: str
    # retrieved_chunks: List[RetrievedChunk]
    # chunks_count: int
    answer: str


# --- Health Check ---
@router.get("/health")
def query_health():
    return {"query_service": "ok"}


# --- Main RAG Query Endpoint ---
@router.post("/query", response_model=QueryResponse)
async def query_documents(request: QueryRequest):
    """
    RAG Query Pipeline:
    1. Refine the user query using LLM
    2. Generate embeddings for the refined query
    3. Perform similarity search in vector database
    4. Return top K most similar chunks
    
    Args:
        request: QueryRequest containing the user's query and top_k parameter
        
    Returns:
        QueryResponse with refined query and retrieved document chunks
    """
    
    # --- Step 1: Query Refinement using LLM ---
    print(f"üìù Original Query: {request.query}")
    
    try:
        # Get the LLM to refine the query
        refined_query = await refine_query(request.query)
        print(f"‚ú® Refined Query: {refined_query}")
    except Exception as e:
        print(f"‚ùå Query refinement failed: {e}")
        raise HTTPException(
            status_code=500,
            detail=f"Query refinement failed: {str(e)}"
        )
    
    # --- Step 2: Generate Embedding for Refined Query ---
    try:
        # Prepare payload for embeddings (same format as document ingestion)
        query_payload = {
            "input": [refined_query]
        }
        
        async with aiohttp.ClientSession() as session:
            embedding_response = await embed_text(session, query_payload)
            
        # Extract the embedding vector
        embeddings = embedding_response.get("embedding")
        
        if not embeddings or len(embeddings) == 0:
            raise HTTPException(
                status_code=500,
                detail=f"Failed to generate query embedding. Got: {embedding_response}"
            )
        
        query_embedding = embeddings[0]  # Get the first (and only) embedding
        print(f"‚úÖ Query embedding generated (dimension: {len(query_embedding)})")
        
    except Exception as e:
        print(f"‚ùå Embedding generation failed: {e}")
        raise HTTPException(
            status_code=500,
            detail=f"Embedding generation failed: {str(e)}"
        )
    
    query_embedding = [-0.06496410071849823, 0.0320940837264061, 0.01478180568665266, -0.01703266240656376, -0.013688949868083, 0.01997971534729004, -0.07008587568998337, 0.050691157579422, 0.06627243757247925, -0.01223087403923273, 0.03305453434586525, -0.053374357521533966, 0.023997830227017403, -0.01145869679749012, 0.012682443484663963, -0.015252746641635895, -0.007805431727319956, 0.073961041867733, -0.06775523722171783, 0.01284466590732336, 0.0023798916954547167, 0.03833155333995819, -0.03993002325296402, -0.003903598990291357, -0.02249342016875744, 0.027373123914003372, 0.039276253432035446, 0.021919166669249535, 0.036199409514665604, -0.04423041269183159, 0.07120202481746674, -0.02655864506959915, -0.018701940774917603, 0.01651337742805481, 0.031962934881448746, 0.005272189620882273, 0.022020699456334114, -0.04081569239497185, 0.03347395732998848, -0.06251165270805359, -0.06335034221410751, 0.034820862114429474, -0.012771238572895527, -0.02392549254000187, 0.002320448635146022, -0.09459789842367172, -0.06917806714773178, -0.038659993559122086, 0.010679270140826702, 0.014096243306994438, -0.010500355623662472, 0.04308895766735077, -0.0010483310325071216, 0.04696789011359215, 0.0846216157078743, 0.026346640661358833, -0.011061195284128189, -0.04350826144218445, -0.025974933058023453, -0.024426564574241638, 0.018410783261060715, 0.04991689324378967, -0.02326531708240509, 0.031105395406484604, 0.04512406140565872, 0.0019362464081496, 0.0404743030667305, 0.003673610743135214, 0.004395932890474796, 0.10127931833267212, -0.014977226965129375, -0.004940500017255545, -0.006395383737981319, -0.10113997757434845, 0.18125256896018982, 0.10430493205785751, -0.051224417984485626, -0.03592129051685333, 0.03324437513947487, -0.0003973707789555192, -0.010662141256034374, 0.10798057913780212, -0.0363401435315609, 0.009421216323971748, 0.06248321011662483, -0.008589421398937702, 0.015736518427729607, -0.01712847501039505, 0.041035182774066925, -0.025876231491565704, 0.020495468750596046, 0.0016532775480300188, -0.049648113548755646, 0.07402755320072174, 0.01769944094121456, -0.06752120703458786, -0.06286294013261795, -0.029539616778492928, -0.0004068845300935209, -0.00034374839742667973, -0.016695788130164146, -0.016543811187148094, -0.0050581274554133415, 0.07356852293014526, 0.022938502952456474, -0.06254836171865463, -0.0076661137863993645, 0.010621494613587856, -0.0012201126664876938, 0.005715073086321354, 0.028949573636054993, -0.00710377749055624, -0.03819006681442261, -0.02228046953678131, -0.001423299196176231, -0.006169773638248444, -0.08749955892562866, 0.0471496656537056, 0.00019982203957624733, 0.04058302938938141, 0.0265649426728487, -0.029839539900422096, 0.009727698750793934, -0.045399248600006104, -0.0019809924997389317, 0.00524379825219512, -0.03038652427494526, 0.007806617766618729, -0.024473782628774643, -0.03428537771105766, 0.0386756956577301, 0.009911634027957916, 0.04449189826846123, 0.02188962697982788, -0.04084872454404831, 0.013913595117628574, -0.05770006775856018, 0.07072587311267853, -0.016372734680771828, -0.0037443465553224087, 0.013903820887207985, -0.0045470562763512135, -0.008914257399737835, 0.11236347258090973, 0.03326496481895447, 0.037417344748973846, -0.04639466479420662, 0.01482090912759304, 0.014822117984294891, -0.021215617656707764, 0.031476739794015884, -0.028899626806378365, -0.043794650584459305, 0.01361057534813881, -0.05442219600081444, -0.0017278889426961541, 0.029291998594999313, -0.0032698975410312414, 0.007743896450847387, -0.04477781429886818, -0.03175989165902138, -0.034883011132478714, 0.024568133056163788, 0.05402972176671028, 0.0419321171939373, 0.11216290295124054, -0.007780113723129034, 0.03661706671118736, -0.03273935988545418, 0.06746397167444229, -0.004986618645489216, -0.019028130918741226, -0.012763790786266327, -0.02882489375770092, -0.006282354239374399, 0.02626497484743595, 0.02168356254696846, 0.019702190533280373, 0.028519585728645325, -0.04029805585741997, -0.041680410504341125, 0.030452821403741837, -0.06733549386262894, 0.009377365931868553, -0.06689547002315521, 0.03407846763730049, -0.04742971807718277, 0.011340539902448654, -0.05018815025687218, -0.022979581728577614, -0.05530600994825363, -0.05499664321541786, 0.021573593840003014, -0.008398197591304779, -0.009301195852458477, -0.004037521313875914, 0.08377066999673843, -0.022224437445402145, -0.07222773134708405, -0.03366951271891594, 0.020651139318943024, 0.000613624055404216, -0.007041025906801224, 0.014082205481827259, 0.007703416049480438, 0.0576261542737484, -0.022163931280374527, 0.045511845499277115, -0.029993019998073578, -0.023569341748952866, -0.03298843279480934, 0.008816873654723167, -0.03580009192228317, -0.06532178819179535, 0.0005253086565062404, -0.010862999595701694, 0.00046185878454707563, -0.03837499022483826, 0.009164880029857159, -0.04584278166294098, -0.05054790899157524, -0.011993030086159706, 0.006106052082031965, -0.014507495798170567, -0.008639571256935596, 0.006777084432542324, -0.012242105789482594, 0.023649321869015694, 0.03569842129945755, -0.016897859051823616, 0.026299335062503815, -0.007452282588928938, -0.026399213820695877, -0.052526991814374924, -0.028115658089518547, 0.008997196331620216, -0.078090600669384, 0.0027551809325814247, 0.047947000712156296, 0.00813446007668972, 0.0008184407488442957, 0.012517445720732212, 0.01969173364341259, 0.0802881121635437, 0.03811022639274597, -0.04244671016931534, 0.02885272353887558, 0.004276392515748739, 0.04366832226514816, -0.013976986519992352, -0.014115926809608936, -0.015427900478243828, 0.02788206934928894, 0.049699991941452026, -0.00020474629127420485, -0.0346660353243351, 0.07159093022346497, -0.034909818321466446, -0.005094638094305992, 0.04675238952040672, 0.008185348473489285, -0.02661808207631111, -0.006154263857752085, 0.044168051332235336, -0.004822590854018927, 0.015718670561909676, 0.003563684644177556, 0.04812319204211235, -0.0046719699166715145, -0.0040894984267652035, 0.016343943774700165, -0.01294696144759655, -0.027846766635775566, 9.583315113559365e-05, 0.05134141817688942, 0.039325714111328125, -0.0031370646320283413, 0.017214855179190636, 0.018420271575450897, 0.02106190286576748, -0.02253909222781658, 0.015774553641676903, -0.003045835066586733, 0.032837554812431335, 0.027204876765608788, -0.05095053091645241, -0.04353736713528633, -0.06986083090305328, -0.042553216218948364, 0.02268879860639572, -0.032787904143333435, 0.026552490890026093, 0.031389787793159485, 0.00327426684089005, -0.014441762119531631, 0.015078269876539707, -0.050744760781526566, 0.019698096439242363, -0.05333776772022247, 0.039508018642663956, 0.01552408654242754, -0.023900793865323067, 0.04811108112335205, 0.02358306385576725, 0.030947359278798103, 0.012158106081187725, -0.06183059141039848, 0.027685707435011864, -0.0558592826128006, -0.015002718195319176, -0.03253421559929848, -0.051736731082201004, -0.02917030081152916, -0.02468186616897583, -0.024473121389746666, -0.025439055636525154, -0.0017490736208856106, 0.009492769837379456, 0.0008904795977286994, -0.0016279383562505245, -0.03083600103855133, -0.009764011949300766, -0.006117306649684906, 0.0009743743576109409, 0.002120370278134942, 0.017028531059622765, 0.033047035336494446, -0.037381503731012344, -0.09989678114652634, -0.014579853974282742, -0.0017207335913553834, -0.0015464656753465533, 0.072714664041996, 0.003926266450434923, -0.03689517080783844, -0.003287005005404353, 0.033617712557315826, 0.03961492329835892, -0.03794783353805542, -0.004105073865503073, -0.011225034482777119, -0.010304149240255356, 0.032813820987939835, -0.07083126157522202, 0.012241004034876823, 0.051160961389541626, 0.04296548664569855, -0.02238135226070881, 0.008552907966077328, 0.0031080138869583607, 0.01704561896622181, -0.03905460238456726, -0.05199648439884186, 0.038431163877248764, -0.0115957697853446, -0.007390313316136599, -0.002500078873708844, 0.021464848890900612, 0.023160545155405998, 0.03270885720849037, 0.03024805337190628, -0.026540860533714294, 0.008214596658945084, -0.01812651939690113, -0.017542943358421326, 0.02560196816921234, -0.02224334329366684, 0.05141916498541832, 0.05903088301420212, 0.0600590780377388, 0.0033681578934192657, -0.09023074805736542, 0.0400562658905983, -0.05470188334584236, -0.015798350796103477, -0.0039009260945022106, 0.015389645472168922, 0.01178389135748148, 0.004969747271388769, 0.0023118420504033566, 0.008365895599126816, -0.006384002510458231, 0.009855318814516068, -0.010103664360940456, 0.031029196456074715, -0.01483385730534792, 0.0007003757636994123, 0.0175015889108181, -0.027262406423687935, 0.04524137079715729, -0.08341536670923233, -0.020896712318062782, -0.0009041755693033338, -0.038928497582674026, -0.06138748675584793, -0.009517681784927845, 0.009354629553854465, 0.013418197631835938, -0.0315137654542923, -0.023806581273674965, -0.04550271853804588, -0.0053128027357161045, -0.028910614550113678, 0.02042336016893387, -0.07372324913740158, -0.0077313645742833614, -0.020681509748101234, 0.029151763767004013, 0.024354174733161926, -0.018895050510764122, 0.02396853081882, -0.03493206202983856, 0.005941171199083328, -0.012872166931629181, 0.01739436574280262, -0.05010858178138733, -0.01905476115643978, 0.03959592059254646, -0.04221427068114281, 0.019175566732883453, -0.01186683401465416, 0.06987638026475906, 0.08912614732980728, 0.04465280473232269, 0.03127848356962204, 0.06548134982585907, 0.061000823974609375, -0.058659233152866364, 0.012850351631641388, -0.01686725951731205, -0.00030363365658558905, -0.038889069110155106, -0.03410066291689873, 0.03576493263244629, -0.02789326012134552, -0.018910875543951988, -0.0642186850309372, 0.02211291529238224, 0.023784322664141655, 0.00010344911424908787, -0.01956097036600113, -0.015768714249134064, 0.025942504405975342, 0.03181490674614906, -0.04150838404893875, -0.035224251449108124, 0.05602932721376419, 0.02577376365661621, -0.021233370527625084, -0.008439194411039352, 0.03719707950949669, -0.015224957838654518, 0.035114776343107224, -0.08992711454629898, -0.012105169706046581, 0.06661365181207657, 0.01178195234388113, 0.014759085141122341, -0.008577169850468636, 0.042937394231557846, 0.006346610840409994, -0.011987145990133286, -0.020597724243998528, -0.06192580237984657, 0.0076897237449884415, -0.021242797374725342, -0.04465305805206299, -0.015407794155180454, 0.006709488108754158, 0.03390977531671524, 0.02343800477683544, 0.041869089007377625, 0.009173627942800522, 0.0017226457130163908, -0.012814617715775967, 0.00010873557766899467, 0.001975391060113907, -0.020496973767876625, 0.019908860325813293, 0.012263601645827293, -0.027828561142086983, 0.05845976248383522, 0.06254544854164124, -0.02303854376077652, 0.027684664353728294, 0.008227545768022537, -0.04777584969997406, 0.030001696199178696, 0.0016803366597741842, -0.011095225811004639, -0.022428352385759354, 0.0742085725069046, 0.007858259603381157, -0.03153926134109497, -0.003473980352282524, -0.0321398563683033, 0.007717359811067581, 0.0063273306004703045, -0.03604577109217644, 0.04186500608921051, -0.0005037663504481316, 0.060084156692028046, -0.014570978470146656, 0.023183634504675865, -0.052704401314258575, -0.022934358566999435, 0.06399299949407578, 0.01438166294246912, -0.027505148202180862, 0.003366892458871007, 0.019248656928539276, -0.018483102321624756, -0.00987125001847744, 0.036390215158462524, -0.04385875537991524, 0.052183590829372406, -0.03583782538771629, -0.011233058758080006, -0.019441772252321243, -0.02182076685130596, 0.01856558956205845, 0.06848161667585373, 0.01661677286028862, 0.03593270108103752, -0.020595470443367958, 0.041701432317495346, -0.005910209845751524, 0.026053179055452347, 0.008227024227380753, 0.025796860456466675, -0.031307484954595566, 0.0016487911343574524, 0.06778702139854431, 0.011264980770647526, -0.02712910994887352, -0.016055678948760033, 0.044134076684713364, -0.05067168176174164, 0.024553924798965454, 0.0027169331442564726, -0.03666410222649574, 0.014222183264791965, 0.04633540287613869, -0.005506109446287155, -0.01766033098101616, -0.004084834363311529, -0.009606254287064075, -0.044461049139499664, -0.004330773372203112, 0.047557245939970016, 0.04241880029439926, -0.018645139411091805, 0.017628097906708717, 0.0184010062366724, -0.010351328179240227, 0.04137010499835014, 0.04907628521323204, 0.00496100215241313, 0.023368893191218376, -0.0065576666966080666, 0.011476856656372547, 0.031834110617637634, 0.010714737698435783, -0.002969124587252736, 0.033200982958078384, -0.0043430570513010025, 0.059193890541791916, -0.007450408767908812, -0.04011078551411629, -0.0017935589421540499, 0.01484618429094553, 0.024492230266332626, 0.037813324481248856, 0.03852164372801781, 0.018961189314723015, -0.005794905591756105, -0.01484556682407856, -0.007604542654007673, 0.04838360846042633, -0.06044025346636772, -0.00026871770387515426, -0.01631523296236992, 0.024357272312045097, -0.019233888015151024, 0.012857647612690926, -0.007213071454316378, 0.05481649562716484, 0.05324803665280342, -0.002781471237540245, -0.00037854022230021656, -0.05018288642168045, -0.0006053312099538743, -0.0322827585041523, 0.005932897329330444, -0.033014073967933655, -0.01623140275478363, -0.03170051425695419, 0.041613996028900146, 0.07065779715776443, 0.005071730352938175, 0.0032026045955717564, -0.06338782608509064, 0.044938139617443085, -0.017122546210885048, 0.03452016040682793, -0.00661578681319952, -0.008601684123277664, 0.055601686239242554, -0.004595991224050522, 0.062105145305395126, -0.05312276631593704, -0.046408511698246, 0.03044179081916809, 0.007288421969860792, -0.0004935324541293085, 0.014231700450181961, -0.015863200649619102, 0.03833052143454552, 5.169367796042934e-05, -0.017314299941062927, 0.05555194988846779, 0.012638922780752182, -0.015284602530300617, -0.03835947811603546, 0.03462032973766327, 0.007691194768995047, -0.01283000037074089, 0.018523605540394783, 0.03390846028923988, 0.02687651850283146, -0.02583901584148407, 0.017543353140354156, 0.07188112288713455, -0.0348077118396759, -0.030052298679947853, 0.07157354801893234, -0.0016049891710281372, 0.011195056140422821, -0.010589975863695145, -0.023263094946742058, 0.008520134724676609, 0.0067560914903879166, 0.021933890879154205, 0.0340045690536499, -0.017283465713262558, 0.015582917258143425, -0.06592727452516556, -0.043059371411800385, 0.060491930693387985, -0.07915765047073364, -0.03371402993798256, -0.03826860710978508, 0.04526878148317337, 0.002759528812021017, -0.02976236864924431, 0.008866233751177788, 0.005569536704570055, 0.007763260044157505, 0.0397115983068943, 0.003296001348644495, 0.010053948499262333, 0.04769006371498108, 0.0030906377360224724, 0.013309082016348839, -0.1029215082526207, -0.009068858809769154, -0.012727863155305386, 0.013547435402870178, 0.00773270707577467, -0.04874943196773529, 0.038252249360084534, 0.002358668250963092, -0.016454964876174927, 0.046952199190855026, -0.03105117753148079, 0.08164042234420776, -0.05834609270095825, 0.023739270865917206, 0.005996299907565117, 0.020906636491417885, -0.016545871272683144, -0.04594890773296356, -0.02083245851099491, 0.02713889442384243, 0.04678945615887642, -0.02686595357954502, 0.03198736533522606, -0.0393117256462574, -0.002786140190437436, -0.047580208629369736, -0.07450134307146072, 0.05238867178559303, 0.025964707136154175, 0.003097707172855735, -0.009771905839443207, 0.00046529623796232045, -0.044120218604803085, 0.012391437776386738, 0.03113369457423687, 0.017791487276554108, 0.049609772861003876, -0.016099169850349426, 0.026799995452165604, 0.0179231408983469, 0.06302603334188461, -0.002465212484821677, 0.019963549450039864, 0.02796141430735588, 0.026907607913017273, -0.0642455443739891, -0.030060425400733948, 0.0728343203663826, -0.01797359623014927, 0.003935806918889284, -0.023583291098475456, -0.0034129030536860228, 0.057503342628479004, -0.02413966879248619, -0.0009065921767614782, -0.01135998871177435, -0.04672824963927269, -0.02150871604681015, 0.041684553027153015, -0.03700767084956169, 0.003389161080121994, 0.050179287791252136, -0.02763175591826439, 0.028093721717596054, 0.0256700050085783, 0.04725643992424011, -0.022742629051208496, 0.016772029921412468, -0.040808308869600296, 0.0722435787320137, -0.022507552057504654, 0.01766054332256317, -0.010829887352883816, -0.004529144149273634, 0.03544622287154198, 0.0007368115475401282, 0.06273913383483887, 0.030236221849918365, 0.046479128301143646, 0.022477179765701294, 0.019424332305788994, 0.013142484240233898, 0.010906744748353958, 0.023815875872969627, -0.004118987824767828, 0.024202028289437294, 0.0274201650172472, 0.0438811220228672, -0.030728312209248543, 0.005693019833415747, -0.04369702935218811, -0.03232591226696968, 0.026814637705683708, -0.022569969296455383, 0.03177604079246521, 0.0020324711222201586, -0.04878899082541466, 0.015314475633203983, -0.018946876749396324, -0.11738438159227371, 0.0521673746407032, 0.027980908751487732, -0.019577408209443092, -0.019947856664657593]
    # --- Step 3: Similarity Search in Vector Database ---
    try:
        similar_chunks = search_similar_chunks(
            query_embedding=query_embedding,
            top_k=request.top_k
        )
        print(f"üîç Found {len(similar_chunks)} similar chunks")
        
    except Exception as e:
        print(f"‚ùå Similarity search failed: {e}")
        raise HTTPException(
            status_code=500,
            detail=f"Similarity search failed: {str(e)}"
        )
    
    # --- Step 4: Format Response ---
    # Format response
    retrieved_chunks = [
    RetrievedChunk(
        content=chunk["content"],
        document_name=chunk["document_name"],
        page_number=chunk["page_number"],
        chunk_number=chunk["chunk_number"],
        similarity_score=float(chunk.get("similarity_score") or 0.0),
        uploaded_by=chunk["uploaded_by"],
        timestamp=chunk["timestamp"]
    )
    for chunk in similar_chunks
    ]

    contents = [chunk["content"] for chunk in similar_chunks]

    # ---- Step 5: Send to Beam LLM Answer Generator ----
    try:
        answer = await generate_answer(contents, request.query)
        print("üß† Beam Answer Generated!")
    except Exception as e:
        print(f"‚ùå Beam Answer Generator Failed: {e}")
        raise HTTPException(
            status_code=500,
            detail=f"Beam answer generation failed: {str(e)}"
        )
    
    print("‚úÖ Query Process Completed Successfully")
    print(f"üß† Answer: {answer}")

    return QueryResponse(
        answer=answer
    )
    # return QueryResponse(
    #     original_query=request.query,
    #     refined_query=refined_query,
    #     retrieved_chunks=retrieved_chunks,
    #     chunks_count=len(retrieved_chunks)
    # )


# --- Alternative Endpoint: Query without Refinement ---
@router.post("/query/direct", response_model=QueryResponse)
async def query_documents_direct(request: QueryRequest):
    """
    Direct query without LLM refinement.
    Useful for debugging or when refinement is not needed.
    """
    
    print(f"üìù Direct Query (No Refinement): {request.query}")
    
    # Skip refinement, use original query
    refined_query = request.query
    
    # Generate embedding
    try:
        query_payload = {"input": [refined_query]}
        
        async with aiohttp.ClientSession() as session:
            embedding_response = await embed_text(session, query_payload)
            
        embeddings = embedding_response.get("embedding")
        
        if not embeddings or len(embeddings) == 0:
            raise HTTPException(
                status_code=500,
                detail="Failed to generate query embedding"
            )
        
        query_embedding = embeddings[0]
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"Embedding generation failed: {str(e)}"
        )
    
    # Similarity search
    try:
        similar_chunks = search_similar_chunks(
            query_embedding=query_embedding,
            top_k=request.top_k
        )
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"Similarity search failed: {str(e)}"
        )
    
    # Format response
    retrieved_chunks = [
    RetrievedChunk(
        content=chunk["content"],
        document_name=chunk["document_name"],
        page_number=chunk["page_number"],
        chunk_number=chunk["chunk_number"],
        similarity_score=float(chunk.get("similarity_score") or 0.0),
        uploaded_by=chunk["uploaded_by"],
        timestamp=chunk["timestamp"]
    )
    for chunk in similar_chunks
    ]

    
    return QueryResponse(
        original_query=request.query,
        refined_query=refined_query,
        retrieved_chunks=retrieved_chunks,
        chunks_count=len(retrieved_chunks)
    )